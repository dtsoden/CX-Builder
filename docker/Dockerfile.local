# Build CX-Builder from local source
# Multi-stage: build with dev tools, run with only runtime libs

# =============================================================================
# Stage 1: Build
# =============================================================================
FROM node:20-alpine AS build

USER root

# Install build dependencies (compilers + native module headers)
RUN apk add --no-cache git python3 py3-pip make g++ build-base cairo-dev pango-dev

# Install pnpm globally
RUN npm install -g pnpm@9

WORKDIR /app

# Copy all source files
COPY . .

# Install dependencies and build
RUN pnpm install && pnpm build

# Prune dev dependencies â€” keeps only production deps in node_modules
RUN pnpm prune --prod

# Aggressive cleanup of files not needed at runtime
RUN rm -rf .git .github .claude .migration .dockerignore \
    && rm -rf packages/server/src packages/ui/src packages/components/src \
    && rm -rf packages/api-documentation \
    && rm -rf node_modules/.cache \
    # Remove build tools that survived prune (not needed at runtime)
    && find node_modules/.pnpm -maxdepth 1 -type d -name "turbo-*" -exec rm -rf {} + 2>/dev/null; true \
    && find node_modules/.pnpm -maxdepth 1 -type d -name "typescript@*" -exec rm -rf {} + 2>/dev/null; true \
    && find node_modules/.pnpm -maxdepth 1 -type d -name "@swc+core*" -exec rm -rf {} + 2>/dev/null; true \
    && find node_modules/.pnpm -maxdepth 1 -type d -name "protoc-gen-ts@*" -exec rm -rf {} + 2>/dev/null; true \
    && find node_modules/.pnpm -maxdepth 1 -type d -name "turbo@*" -exec rm -rf {} + 2>/dev/null; true \
    # Remove wrong-platform binaries (Alpine=musl, these are gnu/glibc)
    && find node_modules/.pnpm -maxdepth 1 -type d -name "*-linux-x64-gnu@*" -exec rm -rf {} + 2>/dev/null; true \
    && find node_modules/.pnpm -maxdepth 1 -type d -name "*-linux-x64-gnu" -exec rm -rf {} + 2>/dev/null; true \
    && find node_modules/.pnpm -maxdepth 1 -type d -name "@img+sharp-libvips-linux-x64@*" -exec rm -rf {} + 2>/dev/null; true \
    # Remove onnxruntime-web (server-side only, web version not needed)
    && find node_modules/.pnpm -maxdepth 1 -type d -name "onnxruntime-web@*" -exec rm -rf {} + 2>/dev/null; true \
    # General cleanup: source maps, TypeScript source, test dirs, docs
    && find . -name "*.ts" -not -name "*.d.ts" -delete 2>/dev/null; true \
    && find . -name "*.map" -delete 2>/dev/null; true \
    && find . -name "*.md" -delete 2>/dev/null; true \
    && find . -type d -name ".turbo" -exec rm -rf {} + 2>/dev/null; true \
    && find . -type d -name "coverage" -exec rm -rf {} + 2>/dev/null; true \
    && find . -type d -name "__tests__" -exec rm -rf {} + 2>/dev/null; true \
    && find . -type d -name "test" -path "*/node_modules/*/test" -exec rm -rf {} + 2>/dev/null; true \
    && find . -type d -name "docs" -path "*/node_modules/*/docs" -exec rm -rf {} + 2>/dev/null; true \
    && rm -rf /root/.local/share/pnpm/store

# =============================================================================
# Stage 2: Runtime (no compilers, only shared libs)
# =============================================================================
FROM node:20-alpine

# Install ONLY runtime libraries (not -dev packages or build tools)
RUN apk add --no-cache \
    chromium \
    curl \
    libc6-compat \
    cairo \
    pango \
    fontconfig \
    freetype \
    harfbuzz \
    pixman \
    libjpeg-turbo \
    giflib \
    librsvg \
    git

# Set Puppeteer environment
ENV PUPPETEER_SKIP_DOWNLOAD=true
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser

WORKDIR /app

# Copy built application from build stage
COPY --from=build /app /app

WORKDIR /app/packages/server

# The server uses oclif for CLI commands
ENTRYPOINT ["node", "bin/run"]
CMD ["start"]
